// Copyright (c) 2020 Oracle and/or its affiliates.
// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.

image::https://oci-resourcemanager-plugin.plugins.oci.oraclecloud.com/latest/deploy-to-oracle-cloud.svg[Deploy on Oracle Cloud, link="https://cloud.oracle.com/resourcemanager/stacks/create?zipUrl=https://github.com/ocilabs/default-configuration/archive/refs/heads/main.zip"]

== ocloud Framework

image:https://img.shields.io/badge/license-UPL-green[link="LICENSE"]

In recent years cloud infrastructure has become a very popular alternative to traditional data center. An increasing number of enterprise IT departments outsource their infrastructure operation to a cloud provider. Relying on a delivery framework for service assets helps operators to keep service manager empowered, aligning their services with the needs of a business. Business value is measured in reduced cost, decreased time-to-market or increased revenue. Cloud infrastructure increases operational efficeincy and avoids investment risks with global resource pools provide IT resources on-deamnd and programmatically. But while launching a server has become a matter of pressing a button, building a hosting platform for intra- and extranet services is more challenging. Operators need to comply with security and compliance guidlines before provisioning their first resource. This framework aims for accelerating that process. Operators start with default configuration and refine their platform in small incremental steps. link:https://en.wikipedia.org/wiki/Infrastructure_as_code["Infrastructure as Code" (IaC)] is employed to extract configurations parameters from service assets and to inherit operator controls during the provisioning process. link:https://docs.oracle.com/en-us/iaas/Content/ResourceManager/Concepts/resourcemanager.htm[Oracle's Resource Manager (ORM)] is used to generate graphical user interfaces and REST-API from code variables automatically. This enables operations engineers to build templates that trigger provisioning processes for new resources with a service deployment. Service manager benefit from on-demand infrastructure, operators remain in control and effectuate security and comliance guidlines. 

=== Architecture
The ocloud framework acclerates the adoption of link:https://www.oracle.com/cloud/[Oracle Cloud Infrastructure (OCI)], providing a baseline configuration for service deployments. Rather than separating service design and infrastructure automation, deployment templates include instructions for provisioning infrastructure. for their service assets. responsibility for operating assets and services is splitted between resource provider and consumer.  defines a link:assets/resident[service resident] for an OCI tenancy. The resident isolates service assets through network segmentation and creates administrator domains for operations. A domain combines OCI compartments with groups, policies, identity tags and notifications. The default configuration separates system operators from network-, database-, and security operators.

[#img-architecture] 
.Baseline Configuration 
image::https://raw.githubusercontent.com/ocilabs/images/main/base_config.drawio.png[Baseline Configuration]

A network segment represents a Virtual Cloud Network (VCN) incl. a dynamic routing gateway and gateways for the Oracle Service Network, Internet and NAT zones. Every segment contains a number subnets, defined using Terraform's  link:https://www.terraform.io/language/functions/cidrsubnet[cidrsubnet()] function. The subnet combines smaller IP spaces with firewalls and route rules. A firewall represents port filter on subnet level, these are implemented using security lists. In the default configuration egress traffic is allowed, ingress traffic is limited to a minimum set of application profiles and will need adjustments when launching a service. The default configuration is also limited to one, obligatory edge router. Adding network segments to the topology, additional routers can be associated with new VCN, naming both equally.  Gateways are activated per default, but can be deactivated using the resource manager interface. 


=== Recommendations
Provisioning templates extract configuration parameter from the deployment code. This enables operators to start with a recommendet set of resources and refine the configuration in incremental steps. The state-aware provisioning process suggests an iterative approach, applying the SCRUM method. A team is made up of system administrator with expertise in application management, network-, database- and security operations. Storing the code in a git repository and connecting the Resource Manager (ORM) with the code source allows administrators to customize a configuration, even when they are not familar with HCL or Terraform. Network and security settings are captured in JSON files, stored in an own directory and can be edited without touching the deployment templates.

[#img-architecture] 
.Code Delivery
image::https://raw.githubusercontent.com/ocilabs/images/main/code_delivery.drawio.png[Code Delivery]

The framework aims to provide more flexibility for infrastructure operators. The goal is a link:https://en.wikipedia.org/wiki/Continuous_delivery[continuous delivery] process for hardware resources. This is accomplished by making Git the single source of truth provisioning templates. A template describes the desired state of a service resident in a declarative format so that it can be versioned inside a repository. Engineers borrow tools and workflows from software developer. But, instead of using these for application code, operators leverage them for infrastructure automation. The framework lowers the entry barriers approaching end-to-end automated infrastructure stacks in three steps: 

- *Cloud Discovery*: Initial deployment with default settings offers a foundation for a first service deployment. Operators evaluate the various configuration options, OCI has to offer, with a real implementation. This enables engineers to introduce OCI to system administrators and service owners and discover services that help to bootstrap service operation tasks. 
- *Architecture Refinement*: Configuration parameters are stored as lists of objects in JSON format. Dependencies are modelled using names. Subject matter experts refine parameter by either add, change or delete objects. The number of arguments has been bootstrapped from the original resource descriptions. Combining mulitple resources into assets allows reduce the arguments significantly and use a terminology that system administrators know.
- *Service Composition*: The objective of every adoption project is the definition of a service. Beside refining the topology, servers need to be configured and application installed. Bash scripts can be added to a host configuration or predefined services can be attached to a resident. An attachement module allows to attaching services from the Oracle Service Network, building individual services requires service modules that are either provieded as blueprints or can be defined by operations engineers.


=== Considerations
The service configuration module is the first out of three obligatory modules that build a landing zone for new services in OCI. The link:https://docs.oracle.com/en-us/iaas/Content/ResourceManager/Concepts/resourcemanager.htm[resource manager (ORM)] is used to expose assets through proteced user- and application interfaces, keeping service owners in charge to determine when and where a service will be launched. The default schema offers a couple of options for a landing zone deployment.

* *Tenancy Classification*: The class parameter helps to constraint resource deployments according to the service limits associated with contract for a tenancy. 

* *Resident Configuration*: In the second section meta data assciated with a resident is collected. Names should be unique for a tenancy to avoid conflicts for resources, defined on root level. The lifecycle stage helps engineers to avoid over provisioning of resources that take a long time to be destroyed.

* *Topology Options*: Executing the default deployment plan, the resource manager offers a choice of topologies that enable common use cases like enterprise applications, big-data and cloud-native services. These options can also be combined to build hybrid services. The opology selection triggers the subnet topology for a segment.

* *Network Settings*: Generic network parameter trigger the level of exposure to the public internet. Activating the internet gateway will expose a frontend, and/or load balancer network to the public internet.   

* *Domain Protection*: The default protection setting is triggered by the lifecycle setting, however can be changed should that be required.

==== Refine settings into company specifc service assets
Service configuration parameters allow for changes in design, scale and scope of a service. This enables operations engineers to collect input from practitioners. Managing the availability of services, controlling demand, optimizing capacity utilization, scheduling of operations and fixing problems depends on operation . Practioners guide operations engineers through new models and architectures such as shared services, utility computing, web services and mobile commerce.

* link:https://github.com/ocilabs/default-configuration/blob/main/default/resident/domains.json[Administrator Domains] : An administrator domain is an area of expertise, representing a group of administrators. Each domain manages administrator priviledges and policies independently. Names must be unique for a service resident. Compartments reflect administrator domains in OCI and enable the separation of duties. The domain component adds a typical set of infrastructure resources, policies, guidelines and management services to each compartment. Domains can be customized in the link:https://www.terraform.io/docs/language/modules/syntax.html[module block] of the respective administrator template. 

* link:https://github.com/ocilabs/default-configuration/blob/main/default/resident/roles.json[Administrator Roles] : Accountable to the organization for stewardship of service assets of the resident.

* link:https://github.com/ocilabs/default-configuration/blob/main/default/resident/controls.json[Operator Controls] : Operations Control aims to monitor and control the IT services and their underlying infrastructure. 

* link:https://github.com/ocilabs/default-configuration/blob/main/default/resident/tags.json[Resource Tags] : Resource tags are used to identify a group of associated resources

* link:https://github.com/ocilabs/default-configuration/blob/main/default/resident/channels.json[Notification Channels] : Alert messaging (or alert notification) is machine-to-person communication that is important or time sensitive

* link:https://github.com/ocilabs/default-configuration/blob/main/default/network/segments.json[Network Segments] : Segmentation divides a computer network into smaller parts. The purpose is to improve network performance and security. 

* link:https://github.com/ocilabs/default-configuration/blob/main/default/network/subnets.json[Subnmets] : A subnetwork or subnet is a logical subdivision of an IP network

* link:https://github.com/ocilabs/default-configuration/blob/main/default/network/routers.json[Edge Router] : An edge router is a specialized router located at a network boundary that enables an internal network to connect to external networks. They are primarily used at two demarcation points: the wide area network (WAN) and the internet

* link:https://github.com/ocilabs/default-configuration/blob/main/default/network/routes.json[Routing Destinations] : Routing is the process of selecting a path for traffic in a network or between or across. A route is defined as a pairing between a destination and the attributes

* link:https://github.com/ocilabs/default-configuration/blob/main/default/network/firewalls.json[Firewalls] : Allowing or blocking network packets into or out of a device or the network based on their application (port number)

* link:https://github.com/ocilabs/default-configuration/blob/main/default/network/destinations.json[Zones] : A security zone is a portion of a network that has specific security requirements set. Each zone consists of a single interface or a group of interfaces, to which a security policy is applied. ... In a very broad sense, a firewall is used to monitor traffic destined to and originating from a network

* link:https://github.com/ocilabs/default-configuration/blob/main/default/network/ports.json[Application Profiles] : Application Port Profiles include a combination of a protocol and a port, or a group of ports, that is used for Firewall and NAT services on the Edge Gateway.

==== Compose cloud solutions with service assets
*Service Assets* abstract provider specific APIs and contain code that can refer to multiple resource provider in order to merge resources from multiple provider into logical, customer specific resource interfaces. The resources manager comes with a number of link:https://docs.oracle.com/en-us/iaas/Content/ResourceManager/Concepts/providers.htm[service provider] preinstalled, additional can be pulled form the link:https://registry.terraform.io/browse/providers[Terraform registry], using the link:https://www.terraform.io/docs/language/providers/configuration.html[provider block]. Components reflect best practices, collected throughout numerous projects and remain subject to change. Initially we provide the following modules:

* Service Attachments - The Oracle Service Network offers a variety of public cloud services that can be attached to a private service through a service gateway.
* Service Assets - Terraform modules represent service assets. Predefined modules can be invoked referring to OCI modules in the link:https://registry.terraform.io/browse/modules?provider=oci[terraform registry] or to a git repository, containing infrastructure code. A great starting point with limited coding requirements are the link:https://registry.terraform.io/search/modules?q=oci%20cloud%20bricks[cloudbricks] components. 
* Service Modules - ORM Stacks 

=== Deployment
The configuration module translates generic input paramerts into a baseline configuration for OCI resources. Extracting the service configuration from the automation scripts enables an iterative service development process, enabling engineers to work on smaller increments and refine the settings towards the completion of the template. Each increment can be discussed with subject matter experts like application manager, database-, network- or security operators. Applying default settings for increments, enables system administrators to use preliminary deployments and evaluate service designs before putting them into production. Using the resource manager operators can rely on state-aware increments that enable engineers to adjust topologies when requirements evolve. For one-time deployments, the link:https://cloud.oracle.com/resourcemanager/stacks/create?zipUrl=https://github.com/oracle-devrel/terraform-oci-ocloud-landing-zone/archive/refs/heads/main.zip[Deploy to the Oracle Cloud] button creates a zip archive that is pushed to the resource manager directly, to enable continuous changes the code should be cloned into a private repository and be connected as a source provider.

[#img-configuration] 
.Service Configuration 
image::https://raw.githubusercontent.com/ocilabs/images/main/service_configuration.drawio.png[Service Configuration]

==== Resource Interfaces

Modules deploy a variety of different resources, like infrastructure components, predefined cloud services, applications or third party software products. Usually we employ the terraform service provider to provision resources, however, command line scripts, API or SDK are additional options.

[cols="1,1,1,1,1",frame=ends,grid=rows,stripes=hover,options="header"]
|===
|            | Admin domain | Network Segment    | Network Domain | Application Host
| Core       | Compartment   | VCN, DRG           | Subnet         | host
| Routing    |               | DRG, internet, NAT, osn |                | 
| Roles      | Group, Policy |                    |                | 
| Portfilter |               |                    | Sec. List      | Sec. Group
| SSH        |               |                    | Bastion        | Session
|=== 


==== Prerequisites
Code is written in HashiCorp Configuration Language (HCL), includes data stored in JSON format and cloud init scripts. We use the OCI Resource Manager service to install, configure, and manage Terraform code in order to support a fast adoption of the "infrastructure-as-code" model.

* link:https://www.oracle.com/cloud/free/[Oracle Cloud Infrastructure (OCI) Account] 
* link:https://docs.oracle.com/en-us/iaas/Content/ResourceManager/Concepts/resourcemanager.htm[Oracle Resource Manager]
* link:https://www.terraform.io[HashiCorp Terraform]
* link:https://registry.terraform.io/providers/hashicorp/oci/latest[Terraform Service Provider for OCI]
* link:https://registry.terraform.io/providers/hashicorp/time/latest[Terraform Time Service Provider]
* link:https://cloudinit.readthedocs.io/en/latest/[Cloud Init]

The landing zone is meant to provision resources in an isolated compartment. The naming should be unique though, because some resources, like tag namepaces and policy groups are defined on root level. While compartment names are constructed to avoid overlaps, name conflicts are avoided referring to a tenancy specific link:doc/naming.adoc[naming convention].

=== Notes/Issues
* It is recommended to run the first "terraform apply" without bastion session enabled. Enabling the bastion session in the first run will produce an error message. Run the "apply" a second time resolves the issue. 
* The resource manager is using some terms internally, these need to be avoided defining a stack. examples are "user" or "domain".
* Destroying compartments and tag namespaces should be an exception and can take a long time. Best practice is destroying all other resources using a reduce apply scope, before destroying the compartments with a destroy command. In the default setup, the "enable_delete" flag prevents un-intensional destroy of compartments. 
* The stack deploys multiple tag namespaces that can only be destroyed one by one. Hence, running destroy for the first and second time will fail and the process has to be repeated at least twice.

=== URLs
This repository is intended to be used with the Oracle Resource Manager. Using the "Deploy to Oracle Cloud" button requires users to link:https://www.oracle.com/cloud/sign-in.html[sign in].

=== Contributing
This project is a community project the code is open source.  Please submit your contributions by forking this repository and submitting a pull request!  Oracle appreciates any contributions that are made by the open source community.

=== License
Copyright (c) 2021 Oracle and/or its affiliates.

Licensed under the Universal Permissive License (UPL), Version 1.0.

See link:LICENSE[LICENSE] for more details.
