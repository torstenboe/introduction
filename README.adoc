// Copyright (c) 2020 Oracle and/or its affiliates.
// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.

image::https://oci-resourcemanager-plugin.plugins.oci.oraclecloud.com/latest/deploy-to-oracle-cloud.svg[Deploy on Oracle Cloud, link="https://cloud.oracle.com/resourcemanager/stacks/create?zipUrl=https://github.com/ocilabs/default-configuration/archive/refs/heads/main.zip"]

== ocloud Framework

image:https://img.shields.io/badge/license-UPL-green[link="LICENSE"]

The ocloud framework is a collection of provisioning scripts that acclerate the the adoption of enterprise cloud services with link:https://www.oracle.com/cloud/[Oracle Cloud Infrastructure (OCI)]. While provisioning a cloud server has become a matter of pressing a button, launching hosting platforms for intra- and extranet services is more complex. It requires operators to address security and compliance regulations that are often in conflict with the operating model of public clouds. Cloud infrastructure helps operators to address typical concerns and mitigate the risk of a cloud migration for enterprise IT departments. Manged resources inherit company specific security controls with link:https://en.wikipedia.org/wiki/Infrastructure_as_code["Infrastructure as Code" (IaC)]. Operator launch self-service portals with service assets that comply with strict compliance guidelines. Users benefit from operated, on-demand infrastructure in more than 30 locations. This framework helps system administrators to get started and to acclerate the adoption process. It contains a collection of resources that operators usually employ for enterprise services but extracts configuration parameters from the deployment code to accelerate the build process. It comes with default settings that reflecting best-practices and enable engineering teams to become agile and develop scripts in small, incremental steps. 

=== Architecture

Configuration parameter for operator controls have been separated from the deployment code to enable operators to benefit from automation scripts and runbook modules already before becoming an OCI expert. The link:https://docs.oracle.com/en-us/iaas/Content/ResourceManager/Concepts/resourcemanager.htm[resource manager (ORM)] is used  to expose assets through proteced user- and application interfaces, keeping service owners in charge to determine when and where a service will be launched.  

[#img-architecture] 
.Base Architecture 
image::https://raw.githubusercontent.com/ocilabs/images/main/base_architecture.drawio.png[Base Architecture]

With an OCI tenancy operators gain access to a scalable infrastructure pool. A service resident isolates a private partition and implements the policies for a new team of service operators. Using link:https://docs.oracle.com/en-us/iaas/Content/Identity/Tasks/managingcompartments.htm[compartments] operators separate the application space from shared domains like network and database management. 

Compartments reflect administrator domains in OCI and enable the separation of duties. The domain component adds a typical set of infrastructure resources, policies, guidelines and management services to each compartment. Domains can be customized in the link:https://www.terraform.io/docs/language/modules/syntax.html[module block] of the respective administrator template. 

==== Service Configuration
The service configuration module is the first out of three obligaotry modules that build a landing zone for new services in OCI. It translates generic input paramerts into a baseline configuration for OCI resources. Extracting the service configuration from the automation scripts enables an iterative service development process, enabling engineers to work on smaller increments and refine the settings towards the completion of the template. Each increment can be discussed with subject matter experts like application manager, database-, network- or security operators. Applying default settings for increments, enables system administrators to use preliminary deployments and evaluate service designs before putting them into production. Using the resource manager operators can rely on state-aware increments that enable engineers to adjust topologies when requirements evolve. For one-time deployments, the link:https://cloud.oracle.com/resourcemanager/stacks/create?zipUrl=https://github.com/oracle-devrel/terraform-oci-ocloud-landing-zone/archive/refs/heads/main.zip[Deploy to the Oracle Cloud] button creates a zip archive that is pushed to the resource manager directly, to enable continuous changes the code should be cloned into a private repository and be connected as a source provider.
[#img-configuration] 
.Service Configuration 
image::https://raw.githubusercontent.com/ocilabs/images/main/service_configuration.drawio.png[Service Configuration]

==== Service Assets
Platform components abstract provider specific APIs and contain code that can refer to multiple resource provider in order to merge resources from multiple provider into logical, customer specific resource interfaces. The resources manager comes with a number of link:https://docs.oracle.com/en-us/iaas/Content/ResourceManager/Concepts/providers.htm[service provider] preinstalled, additional can be pulled form the link:https://registry.terraform.io/browse/providers[Terraform registry], using the link:https://www.terraform.io/docs/language/providers/configuration.html[provider block]. Components reflect best practices, collected throughout numerous projects and remain subject to change. Initially we provide the following modules:

* link:assets/resident[Resident] is the compartment block combined with groups and policies that define a working environment for cloud and security operators
* link:assets/network[Network] defines the compartment and role for network administrators together with a Virtual Cloud Network (VCN) incl. Dynamic Routing Gateway and gateways for NAT, Internet and Oracle Services

Additional modules can be invoked referring to OCI modules in the link:https://registry.terraform.io/browse/modules?provider=oci[terraform registry], a great starting point with limited coding requirements are the link:https://registry.terraform.io/search/modules?q=oci%20cloud%20bricks[cloudbricks] components.  

=== Recommendations

=== Considerations

=== Deployment
==== Resource Interfaces

Modules deploy a variety of different resources, like infrastructure components, predefined cloud services, applications or third party software products. Usually we employ the terraform service provider to provision resources, however, command line scripts, API or SDK are additional options.

[cols="1,1,1,1,1",frame=ends,grid=rows,stripes=hover,options="header"]
|===
|            | Admin domain | Network Segment    | Network Domain | Application Host
| Core       | Compartment   | VCN, DRG           | Subnet         | host
| Routing    |               | DRG, internet, NAT, osn |                | 
| Roles      | Group, Policy |                    |                | 
| Portfilter |               |                    | Sec. List      | Sec. Group
| SSH        |               |                    | Bastion        | Session
|=== 


==== Prerequisites
Code is written in HashiCorp Configuration Language (HCL), includes data stored in JSON format and cloud init scripts. We use the OCI Resource Manager service to install, configure, and manage Terraform code in order to support a fast adoption of the "infrastructure-as-code" model.

* link:https://www.oracle.com/cloud/free/[Oracle Cloud Infrastructure (OCI) Account] 
* link:https://docs.oracle.com/en-us/iaas/Content/ResourceManager/Concepts/resourcemanager.htm[Oracle Resource Manager]
* link:https://www.terraform.io[HashiCorp Terraform]
* link:https://registry.terraform.io/providers/hashicorp/oci/latest[Terraform Service Provider for OCI]
* link:https://registry.terraform.io/providers/hashicorp/time/latest[Terraform Time Service Provider]
* link:https://cloudinit.readthedocs.io/en/latest/[Cloud Init]

The landing zone is meant to provision resources in an isolated compartment. The naming should be unique though, because some resources, like tag namepaces and policy groups are defined on root level. While compartment names are constructed to avoid overlaps, name conflicts are avoided referring to a tenancy specific link:doc/naming.adoc[naming convention].

=== Notes/Issues
* It is recommended to run the first "terraform apply" without bastion session enabled. Enabling the bastion session in the first run will produce an error message. Run the "apply" a second time resolves the issue. 
* The resource manager is using some terms internally, these need to be avoided defining a stack. examples are "user" or "domain".
* Destroying compartments and tag namespaces should be an exception and can take a long time. Best practice is destroying all other resources using a reduce apply scope, before destroying the compartments with a destroy command. In the default setup, the "enable_delete" flag prevents un-intensional destroy of compartments. 
* The stack deploys multiple tag namespaces that can only be destroyed one by one. Hence, running destroy for the first and second time will fail and the process has to be repeated at least twice.

=== URLs
This repository is intended to be used with the Oracle Resource Manager. Using the "Deploy to Oracle Cloud" button requires users to link:https://www.oracle.com/cloud/sign-in.html[sign in].

=== Contributing
This project is a community project the code is open source.  Please submit your contributions by forking this repository and submitting a pull request!  Oracle appreciates any contributions that are made by the open source community.

=== License
Copyright (c) 2021 Oracle and/or its affiliates.

Licensed under the Universal Permissive License (UPL), Version 1.0.

See link:LICENSE[LICENSE] for more details.
