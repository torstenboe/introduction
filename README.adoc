// Copyright (c) 2020 Oracle and/or its affiliates.
// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.

image::https://oci-resourcemanager-plugin.plugins.oci.oraclecloud.com/latest/deploy-to-oracle-cloud.svg[Deploy on Oracle Cloud, link="https://cloud.oracle.com/resourcemanager/stacks/create?zipUrl=https://github.com/torstenboettjer/ocloud-default-configuration/archive/refs/heads/main.zip"]

== Service Configuration

image:https://img.shields.io/badge/license-UPL-green[link="LICENSE"]

=== Introduction
The OCloud framework is a collection of configuration scripts, published for operators aiming to build an "own" cloud on Oracle Cloud Infrastructure (OCI). While launching cloud server has become a matter of pressing a button, provisioning a managed infrastructure platform for enterprise applications is more complex. Oracle's cloud controller combines advanced automation with the necessary controls that enable operators to launch intra- or extranet services on demand. link:https://en.wikipedia.org/wiki/Infrastructure_as_code["Infrastructure as Code" (IaC)] is employed to address common compliance and security requirements with agility. The framework allows engineers to learn to utilize the numerous build-in services without blocking an immedeate launch of a new service. It provides a baseline configuration without prescribing a bespoke topology design. link:https://docs.oracle.com/en-us/iaas/Content/ResourceManager/Concepts/resourcemanager.htm[Oracle's Resource Manager (ORM)] ensures a state-aware deployments and allows to adjust the topology when requirements evolve. For one-time deployments, the link:https://cloud.oracle.com/resourcemanager/stacks/create?zipUrl=https://github.com/oracle-devrel/terraform-oci-ocloud-landing-zone/archive/refs/heads/main.zip[Deploy to the Oracle Cloud] button creates a zip archive that is pushed to the resource manager directly, to enable continuous changes the code should be cloned into a private repository and be connected as a source provider.

=== Getting Started
With an OCI tenancy operators gain access to a scalable infrastructure pool. A service resident isolates a private partition and implements the policies for a new team of service operators. Using link:https://docs.oracle.com/en-us/iaas/Content/Identity/Tasks/managingcompartments.htm[compartments] operators separate the application space from shared domains like network and database management. 

[#img-architecture] 
.Base Architecture 
image::doc/image/base_architecture.drawio.png[Base Architecture]

Compartments reflect administrator domains in OCI and enable the separation of duties. The domain component adds a typical set of infrastructure resources, policies, guidelines and management services to each compartment. Domains can be customized in the link:https://www.terraform.io/docs/language/modules/syntax.html[module block] of the respective administrator template. 

=== Customizing the Framework
The code structure distinguishes between administrators and operation engineers. Administrator templates allow operators to customize the provisioning processes for infrastructure resources through parameters. Operations engineers provide platform components, these will be invoked through templates. All templates are written in HCL and require a terraform instance to execute the provision process. For OCI user, ORM provides terraform as a service, manages access to the state backend across teams and provides an UI/API wrapper for self-service deployments. 

[#img-structure] 
.Code Structure 
image::doc/image/code_structure.png[Code Structure]
  
A service deployment starts the provisioning process with the link:init.tf[init.tf] file. A "cloud service" compartment is created, service wide configuration settings are applied. This includes naming conventions, tags and notification settings. The process is customizable through parameters. The stack invokes three different types of parameters: default deployment parameters, defined in the link:schema.tf[schema.tf] file, service parameters, defined in the link:settings/[settings module] and dependencies between resources, defined in the link:config.tf[config.tf] file. Deployment parameters are exposed and can be adjusted when the stack is invoked, settings are client specific and should be reviewed by an operation engineer, settings and dependencies enable the automatic configuration of resources in different components using a common set of parameters. 

==== Administrator Templates
The following four administrator templates will be executed:

* link:operation.tf[operations.tf] prepares a working environment privileged users in the "operation" compartment and contains base role definitions like an auditor or a cloud "super admin".
* link:network.tf[network.tf] provisions a network segment for the service, creates a "presentation" tier for user facing components like load balancer, firewalls and portals and creates a "netops"  role.
* link:database.tf[database.tf] prepares the stack for the provisioning of database hosts in an own network domain, default access ports are 1521-1522 and database administrator role is created.
* link:application.tf[application.tf] creates one application management domain, the respective application compartment, the sysops role and deploys an operator for remote script execution, like HELM Charts, python, bash or ansible scripts.

The operation and network deployment templates are obligatory, the database and application templates are optional. A bastion service connects via SSH to the operator that is placed int application domain.

==== Components
Platform components abstract provider specific APIs and contain code that can refer to multiple resource provider in order to merge resources from multiple provider into logical, customer specific resource interfaces. The resources manager comes with a number of link:https://docs.oracle.com/en-us/iaas/Content/ResourceManager/Concepts/providers.htm[service provider] preinstalled, additional can be pulled form the link:https://registry.terraform.io/browse/providers[Terraform registry], using the link:https://www.terraform.io/docs/language/providers/configuration.html[provider block]. Components reflect best practices, collected throughout numerous projects and remain subject to change. Initially we provide the following modules:

* link:component/admin_domain[Administrator domain] is the compartment block combined with groups and policies that define a working environment for cloud and security operators
* link:component/network_segment[Network Segment] defines the compartment and role for network administrators together with a Virtual Cloud Network (VCN) incl. Dynamic Routing Gateway and gateways for NAT, Internet and Oracle Services
* link:component/network_domain[Network Domain] the necessary subnets with port filters and routing rules to host the application tiers
* link:component/application_host[Application Host] launches a compute node to execute the configuration scripts like Helm Charts, Python, SQL, Bash or Ansible scripts

Additional modules can be invoked referring to OCI modules in the link:https://registry.terraform.io/browse/modules?provider=oci[terraform registry], a great starting point with limited coding requirements are the link:https://registry.terraform.io/search/modules?q=oci%20cloud%20bricks[cloudbricks] components.  

==== Resource Interfaces

Modules deploy a variety of different resources, like infrastructure components, predefined cloud services, applications or third party software products. Usually we employ the terraform service provider to provision resources, however, command line scripts, API or SDK are additional options.

[cols="1,1,1,1,1",frame=ends,grid=rows,stripes=hover,options="header"]
|===
|            | Admin domain | Network Segment    | Network Domain | Application Host
| Core       | Compartment   | VCN, DRG           | Subnet         | host
| Routing    |               | DRG, internet, NAT, osn |                | 
| Roles      | Group, Policy |                    |                | 
| Portfilter |               |                    | Sec. List      | Sec. Group
| SSH        |               |                    | Bastion        | Session
|=== 


==== Prerequisites
Code is written in HashiCorp Configuration Language (HCL), includes data stored in JSON format and cloud init scripts. We use the OCI Resource Manager service to install, configure, and manage Terraform code in order to support a fast adoption of the "infrastructure-as-code" model.

* link:https://www.oracle.com/cloud/free/[Oracle Cloud Infrastructure (OCI) Account] 
* link:https://docs.oracle.com/en-us/iaas/Content/ResourceManager/Concepts/resourcemanager.htm[Oracle Resource Manager]
* link:https://www.terraform.io[HashiCorp Terraform]
* link:https://registry.terraform.io/providers/hashicorp/oci/latest[Terraform Service Provider for OCI]
* link:https://registry.terraform.io/providers/hashicorp/time/latest[Terraform Time Service Provider]
* link:https://cloudinit.readthedocs.io/en/latest/[Cloud Init]

The landing zone is meant to provision resources in an isolated compartment. The naming should be unique though, because some resources, like tag namepaces and policy groups are defined on root level. While compartment names are constructed to avoid overlaps, name conflicts are avoided referring to a tenancy specific link:doc/naming.adoc[naming convention].

=== Notes/Issues
* It is recommended to run the first "terraform apply" without bastion session enabled. Enabling the bastion session in the first run will produce an error message. Run the "apply" a second time resolves the issue. 
* The resource manager is using some terms internally, these need to be avoided defining a stack. examples are "user" or "domain".
* Destroying compartments and tag namespaces should be an exception and can take a long time. Best practice is destroying all other resources using a reduce apply scope, before destroying the compartments with a destroy command. In the default setup, the "enable_delete" flag prevents un-intensional destroy of compartments. 
* The stack deploys multiple tag namespaces that can only be destroyed one by one. Hence, running destroy for the first and second time will fail and the process has to be repeated at least twice.

=== URLs
This repository is intended to be used with the Oracle Resource Manager. Using the "Deploy to Oracle Cloud" button requires users to link:https://www.oracle.com/cloud/sign-in.html[sign in].

=== Contributing
This project is a community project the code is open source.  Please submit your contributions by forking this repository and submitting a pull request!  Oracle appreciates any contributions that are made by the open source community.

=== License
Copyright (c) 2021 Oracle and/or its affiliates.

Licensed under the Universal Permissive License (UPL), Version 1.0.

See link:LICENSE[LICENSE] for more details.
